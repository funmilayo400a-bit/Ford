<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Ford Bank</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CRITICAL STYLES -->
  <style>
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
    .modal.active { display: flex; }
    .profile-card { display: none !important; }
    .profile-card.visible { display: block !important; animation: fadeInUp 0.4s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .badge.warning { background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
  </style>
</head>
<body class="dashboard-page">

  <!-- Navigation -->
  <nav class="navbar">
    <div class="container nav-container">
      <div class="logo">
        <h2>Ford<span>Bank</span></h2>
      </div>
      <ul class="nav-links" id="navLinks">
        <li><a href="index.html">Home</a></li>
        <li><a href="accounts.html">Accounts</a></li>
        <li><a href="savings.html">Savings</a></li>
        <li><a href="investing.html">Investing</a></li>
        <li><a href="support.html">Support</a></li>
        <li><a href="#" id="logoutBtn" class="btn-login">Logout</a></li>
      </ul>
      <div class="mobile-menu-toggle">Menu</div>
    </div>
  </nav>

  <!-- Dynamic Greeting Header -->
  <header class="dashboard-header">
    <div class="container">
      <div class="greeting-container">
        <h1 id="dynamicGreeting">Welcome, <span id="userName"></span>!</h1>
        <p class="subtitle" id="greetingSubtitle">Your account is secure and ready.</p>
      </div>
      <p class="account-info">Account: <strong id="userAccNum"></strong></p>
    </div>
  </header>

  <!-- First-Time User Banner -->
  <div id="firstTimeBanner" class="banner info" style="display:none;">
    <div class="container">
      <div class="banner-content">
        <span class="icon">Lock</span>
        <div>
          <strong>Secure your account</strong><br>
          <small>Set your 4-digit PIN to enable transfers and payments.</small>
        </div>
        <button class="btn-primary small" onclick="window.openSetPinModal()">Set PIN</button>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <section class="dashboard-content">
    <div class="container">
      <!-- SHOW PROFILE + CHANGE PIN BUTTON -->
      <div style="text-align:center; margin: 1.5rem 0;">
        <button class="show-profile-btn" onclick="window.toggleProfile()">Show Profile</button>
        <button class="btn-secondary small" onclick="window.openChangePinModal()" style="margin-left: 10px;">Change PIN</button>
        <button class="btn-secondary small" onclick="window.refreshTransactions()" style="margin-left: 10px;">Refresh</button>
      </div>

      <div class="dashboard-grid">
        <!-- USER PROFILE CARD -->
        <div class="card profile-card">
          <div class="card-header">
            <h3>User Profile</h3>
            <button class="btn-icon" onclick="window.openEditProfile()">Edit</button>
          </div>
          <div class="card-body">
            <div class="profile-avatar">
              <div class="avatar-circle">
                <span id="profileInitials"></span>
              </div>
            </div>
            <div class="profile-details">
              <p><strong>Full Name:</strong> <span id="profileName"></span></p>
              <p><strong>Email:</strong> <span id="profileEmail"></span></p>
              <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
              <p><strong>Address:</strong> <span id="profileAddress"></span></p>
              <p><strong>Date of Birth:</strong> <span id="profileDOB"></span></p>
              <p><strong>Account Created:</strong> <span id="profileCreated"></span></p>
            </div>
          </div>
        </div>

        <!-- Balance Card -->
        <div class="card balance-card">
          <div class="card-header">
            <h3>Available Balance</h3>
            <span class="badge success">Active</span>
          </div>
          <div class="card-body">
            <p class="balance-amount">$<span id="userBalance">0.00</span></p>
            <button class="btn-primary" onclick="window.openTransferModal()">Transfer Money</button>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card quick-actions">
          <div class="card-header">
            <h3>Quick Actions</h3>
          </div>
          <div class="card-body">
            <div class="action-grid">
              <button class="action-btn" onclick="window.openPayBillModal()">Pay Bills</button>
              <button class="action-btn" onclick="window.openDepositModal()">Mobile Deposit</button>
              <button class="action-btn" onclick="window.openSendMoneyModal()">Send Money</button>
            </div>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card transactions-card">
          <div class="card-header">
            <h3>Recent Transactions</h3>
            <a href="#" class="link-sm" onclick="window.openFullHistory()">View All</a>
          </div>
          <div class="card-body">
            <div id="transactionsList" class="transactions-list">
              <p class="no-data">No recent transactions.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Set PIN Modal -->
  <div id="setPinModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Set Your PIN</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="setPinForm">
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="newPin" maxlength="4" placeholder="••••" required />
          </div>
          <div class="input-group">
            <label>Confirm PIN</label>
            <input type="password" id="confirmPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Set PIN</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Change PIN Modal -->
  <div id="changePinModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Change PIN</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="changePinForm">
          <div class="input-group">
            <label>Current PIN</label>
            <input type="password" id="oldPin" maxlength="4" placeholder="••••" required />
          </div>
          <div class="input-group">
            <label>New 4-Digit PIN</label>
            <input type="password" id="newPinChange" maxlength="4" placeholder="••••" required />
          </div>
          <div class="input-group">
            <label>Confirm New PIN</label>
            <input type="password" id="confirmNewPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Update PIN</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Profile PIN Verification Modal -->
  <div id="editPinVerifyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Verify PIN</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="editPinVerifyForm">
          <p>Enter your 4-digit PIN to continue editing profile.</p>
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="editVerifyPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Verify & Continue</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal (Now after PIN) -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Profile</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="input-group">
            <label>Full Name</label>
            <input type="text" id="editName" required />
          </div>
          <div class="input-group">
            <label>Email</label>
            <input type="email" id="editEmail" required />
          </div>
          <div class="input-group">
            <label>Phone</label>
            <input type="tel" id="editPhone" placeholder="123-456-7890" required />
          </div>
          <div class="input-group">
            <label>Address</label>
            <input type="text" id="editAddress" required />
          </div>
          <div class="input-group">
            <label>Date of Birth</label>
            <input type="date" id="editDOB" required />
          </div>
          <button type="submit" class="btn-primary full">Save Changes</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div id="transferModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Transfer Money</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="transferForm">
          <div class="input-group">
            <label>Amount</label>
            <input type="number" id="transferAmount" placeholder="0.00" step="0.01" min="0.01" required />
          </div>
          <div class="input-group">
            <label>Recipient Account Number</label>
            <input type="text" id="transferAccNum" placeholder="1234567890" maxlength="10" required />
            <small style="color:#666; font-size:0.8em;">Exactly 10 digits</small>
          </div>
          <div class="input-group">
            <label>Recipient Full Name</label>
            <input type="text" id="transferName" placeholder="John Doe" required />
          </div>
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="transferPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Send Transfer</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content small">
      <div class="modal-header">
        <h2>Confirm Transfer</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <p><strong>To:</strong> <span id="confirmName"></span></p>
        <p><strong>Account:</strong> <span id="confirmAcc"></span></p>
        <p><strong>Amount:</strong> $<span id="confirmAmount"></span></p>
        <div class="btn-group">
          <button id="confirmBtn" class="btn-primary">Confirm</button>
          <button id="cancelBtn" class="btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pay Bill Modal -->
  <div id="payBillModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Pay Bill</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="payBillForm">
          <div class="input-group">
            <label>Payee</label>
            <input type="text" id="billPayee" placeholder="Electric Company" required />
          </div>
          <div class="input-group">
            <label>Amount</label>
            <input type="number" id="billAmount" placeholder="0.00" step="0.01" min="0.01" required />
          </div>
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="billPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Pay Now</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Mobile Deposit Modal -->
  <div id="depositModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Mobile Deposit</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="depositForm">
          <div class="input-group">
            <label>Check Amount</label>
            <input type="number" id="depositAmount" placeholder="0.00" step="0.01" min="0.01" required />
          </div>
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="depositPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Deposit Check</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Send Money Modal -->
  <div id="sendMoneyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Send Money</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="sendMoneyForm">
          <div class="input-group">
            <label>Recipient Email</label>
            <input type="email" id="sendEmail" placeholder="friend@example.com" required />
          </div>
          <div class="input-group">
            <label>Amount</label>
            <input type="number" id="sendAmount" placeholder="0.00" step="0.01" min="0.01" required />
          </div>
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="sendPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Send</button>
        </form>
      </div>
    </div>
  </div>

  <!-- FULL TRANSACTION HISTORY MODAL -->
  <div id="fullHistoryModal" class="modal">
    <div class="modal-content large">
      <div class="modal-header">
        <h2>Full Transaction History</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body">
        <div id="fullTransactionsList" class="transactions-list full">
          <p class="no-data">No transactions yet.</p>
        </div>
        <div style="margin-top:1.5rem; text-align:center;">
          <button class="btn-secondary" onclick="window.closeModal()">Back to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TRANSACTION RECEIPT MODAL -->
  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Transaction Receipt</h2>
        <span class="close" onclick="window.closeModal()">x</span>
      </div>
      <div class="modal-body receipt-body">
        <div class="receipt-header">
          <h3>Ford Bank</h3>
          <p>Digital Banking Receipt</p>
        </div>
        <div class="receipt-details">
          <p><strong>Reference ID:</strong> <span id="receiptRef"></span></p>
          <p><strong>Type:</strong> <span id="receiptType"></span></p>
          <p><strong>Amount:</strong> <span id="receiptAmount"></span></p>
          <p><strong>Date:</strong> <span id="receiptDate"></span></p>
          <p><strong>Description:</strong> <span id="receiptDesc"></span></p>
          <p><strong>Account:</strong> <span id="receiptAcc"></span></p>
          <p><strong>Status:</strong> <span id="receiptStatus" class="badge success">Completed</span></p>
        </div>
        <div class="receipt-footer">
          <button class="btn-primary" onclick="window.printReceipt()">Print</button>
          <button class="btn-secondary" onclick="window.closeModal()">Back to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container footer-container">
      <div class="footer-col">
        <div class="footer-logo">
          <h3>Ford<span>Bank</span></h3>
          <p>Digital banking. No nonsense.</p>
        </div>
      </div>
      <div class="footer-col">
        <h4>Products</h4>
        <ul>
          <li><a href="savings.html">Savings Accounts</a></li>
          <li><a href="accounts.html">Checking Accounts</a></li>
          <li><a href="investing.html">Certificates of Deposit</a></li>
          <li><a href="#">Auto Loans</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Company</h4>
        <ul>
          <li><a href="#">About Us</a></li>
          <li><a href="#">Careers</a></li>
          <li><a href="#">Press</a></li>
          <li><a href="#">Investor Relations</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Contact</h4>
        <p>Email: <a href="mailto:fordbank452@gmail.com">fordbank452@gmail.com</a></p>
        <div class="social-links"></div>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">
        <p>© 2007 Ford Bank. Member FDIC. Equal Housing Lender.</p>
        <div class="legal-links">
          <a href="privacy.html">Privacy Policy</a>
          <a href="terms.html">Terms of Use</a>
          <a href="security.html">Security</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Firebase SDK + FULL LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateEmail } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA5r_nrSgK7lEZdG52tqLZZBh5fnQHz9ew",
      authDomain: "allybank-478ad.firebaseapp.com",
      projectId: "allybank-478ad",
      storageBucket: "allybank-478ad.firebasestorage.app",
      messagingSenderId: "805352082325",
      appId: "1:805352082325:web:90cf70bcfd1a057f4f449c",
      measurementId: "G-GPRQK6L99L"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let CURRENT_USER = null;
    let USERS = [];
    let transactionsListener = null;

    function generateRefId() {
      return 'TX' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 3).toUpperCase();
    }

    // FORMAT BALANCE WITH COMMAS
    function formatBalance(amount) {
      return parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // EXPOSE FUNCTIONS
    window.toggleProfile = function() {
      const profileCard = document.querySelector('.profile-card');
      const button = document.querySelector('.show-profile-btn');
      if (!profileCard || !button) return;
      const isVisible = profileCard.classList.toggle('visible');
      button.textContent = isVisible ? 'Hide Profile' : 'Show Profile';
    };

    window.openModal = function(id) {
      const modal = document.getElementById(id);
      if (modal) modal.classList.add('active');
    };

    window.closeModal = function() {
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    };

    document.addEventListener('click', e => {
      if (e.target.classList.contains('modal') && e.target.classList.contains('active')) {
        const content = e.target.querySelector('.modal-content');
        const rect = content.getBoundingClientRect();
        if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) {
          window.closeModal();
        }
      }
    });

    window.openSetPinModal = () => window.openModal('setPinModal');
    window.openChangePinModal = () => {
      if (!CURRENT_USER?.pin) return alert('Set PIN first');
      window.openModal('changePinModal');
    };

    window.openEditProfile = () => {
      if (!CURRENT_USER?.pin) {
        alert('Set PIN first');
        window.openSetPinModal();
        return;
      }
      window.openModal('editPinVerifyModal');
    };

    window.openTransferModal = () => {
      if (!CURRENT_USER?.pin) { alert('Set PIN first'); window.openSetPinModal(); return; }
      window.openModal('transferModal');
    };
    window.openPayBillModal = () => {
      if (!CURRENT_USER?.pin) { alert('Set PIN first'); window.openSetPinModal(); return; }
      window.openModal('payBillModal');
    };
    window.openDepositModal = () => {
      if (!CURRENT_USER?.pin) { alert('Set PIN first'); window.openSetPinModal(); return; }
      window.openModal('depositModal');
    };
    window.openSendMoneyModal = () => {
      if (!CURRENT_USER?.pin) { alert('Set PIN first'); window.openSetPinModal(); return; }
      window.openModal('sendMoneyModal');
    };

    window.openFullHistory = async () => {
      if (!CURRENT_USER) return;
      const list = document.getElementById('fullTransactionsList');
      const snapshot = await getDocs(
        query(collection(db, `users/${CURRENT_USER.id}/transactions`), orderBy('timestamp', 'desc'))
      );
      const txs = [];
      snapshot.forEach(doc => txs.push({ id: doc.id, ...doc.data() }));
      list.innerHTML = txs.length ? txs.map(t => `
        <div class="transaction-item ${t.type}">
          <div class="transaction-info">
            <strong>${t.type === 'deposit' ? '+' : '-'}$${formatBalance(t.amount)}</strong>
            <p>${t.desc}</p>
            ${t.status === 'pending' ? '<span class="badge warning">Pending</span>' : ''}
          </div>
          <small>${new Date(t.date).toLocaleDateString('en-US')}</small>
          <button class="btn-small" onclick="window.openReceipt('${t.id}')">View Receipt</button>
        </div>
      `).join('') : '<p class="no-data">No transactions yet.</p>';
      window.openModal('fullHistoryModal');
    };

    window.openReceipt = async (txId) => {
      if (!CURRENT_USER) return;
      try {
        const txDoc = await getDoc(doc(db, `users/${CURRENT_USER.id}/transactions`, txId));
        const tx = { id: txId, ...txDoc.data() };
        if (!tx.refId) {
          tx.refId = generateRefId();
          await updateDoc(doc(db, `users/${CURRENT_USER.id}/transactions`, txId), { refId: tx.refId });
        }
        document.getElementById('receiptRef').textContent = tx.refId;
        document.getElementById('receiptType').textContent = tx.type.charAt(0).toUpperCase() + tx.type.slice(1);
        document.getElementById('receiptAmount').textContent = (tx.type === 'deposit' ? '+' : '-') + '$' + formatBalance(tx.amount);
        document.getElementById('receiptDate').textContent = new Date(tx.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('receiptDesc').textContent = tx.desc;
        document.getElementById('receiptAcc').textContent = CURRENT_USER.accountNumber;
        const statusEl = document.getElementById('receiptStatus');
        statusEl.textContent = (tx.status || 'approved').toUpperCase();
        statusEl.className = `badge ${tx.status === 'pending' ? 'warning' : 'success'}`;
        window.openModal('receiptModal');
      } catch (err) {
        console.error(err);
      }
    };

    window.printReceipt = () => {
      const content = document.querySelector('.receipt-body').innerHTML;
      const win = window.open('', '', 'width=800,height=600');
      win.document.write(`<html><head><title>Receipt</title></head><body style="font-family:Arial;padding:2rem;">${content}</body></html>`);
      win.document.close();
      win.print();
    };

    window.refreshTransactions = async () => {
      await loadUserData();
    };

    async function loadUserData() {
      if (!CURRENT_USER) return;
      try {
        const userDoc = await getDoc(doc(db, 'users', CURRENT_USER.id));
        if (userDoc.exists()) {
          const data = userDoc.data();
          CURRENT_USER.balance = data.balance || 0;
          document.getElementById('userBalance').textContent = formatBalance(CURRENT_USER.balance);
        }
      } catch (err) {
        console.error("Failed to refresh balance:", err);
      }
    }

    function renderTransactions(txs) {
      const list = document.getElementById('transactionsList');
      const recent = txs.slice(0, 5);
      list.innerHTML = recent.length > 0 ? recent.map(t => `
        <div class="transaction-item ${t.type}">
          <div class="transaction-info">
            <strong>${t.type === 'deposit' ? '+' : '-'}$${formatBalance(t.amount)}</strong>
            <p>${t.desc}</p>
            ${t.status === 'pending' ? '<span class="badge warning">Pending</span>' : ''}
          </div>
          <small>${new Date(t.date).toLocaleDateString()}</small>
          <button class="btn-small" onclick="window.openReceipt('${t.id}')" style="margin-left:auto;">View Receipt</button>
        </div>
      `).join('') : '<p class="no-data">No recent transactions.</p>';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const navLinks = document.getElementById('navLinks');

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        try {
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          if (!userDoc.exists()) {
            await signOut(auth);
            window.location.href = 'login.html';
            return;
          }

          CURRENT_USER = { id: user.uid, ...userDoc.data() };

          if (USERS.length === 0) {
            const usersSnapshot = await getDocs(collection(db, 'users'));
            USERS = [];
            usersSnapshot.forEach(d => USERS.push({ id: d.id, ...d.data() }));
          }

          // UPDATE UI
          document.getElementById('userName').textContent = CURRENT_USER.name;
          document.getElementById('userAccNum').textContent = CURRENT_USER.accountNumber;
          document.getElementById('userBalance').textContent = formatBalance(CURRENT_USER.balance);
          document.getElementById('profileName').textContent = CURRENT_USER.name;
          document.getElementById('profileEmail').textContent = CURRENT_USER.email;
          document.getElementById('profilePhone').textContent = CURRENT_USER.phone || 'Not set';
          document.getElementById('profileAddress').textContent = CURRENT_USER.address || 'Not set';
          document.getElementById('profileDOB').textContent = CURRENT_USER.dob ? new Date(CURRENT_USER.dob).toLocaleDateString() : 'Not set';
          document.getElementById('profileCreated').textContent = CURRENT_USER.createdAt ? new Date(CURRENT_USER.createdAt).toLocaleDateString() : 'Not set';
          document.getElementById('profileInitials').textContent = CURRENT_USER.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

          const hour = new Date().getHours();
          const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
          const greetingEl = document.getElementById('dynamicGreeting');
          const subtitleEl = document.getElementById('greetingSubtitle');
          const bannerEl = document.getElementById('firstTimeBanner');

          if (!CURRENT_USER.pin) {
            greetingEl.innerHTML = `Welcome, <span class="highlight">${CURRENT_USER.name}</span>!`;
            subtitleEl.textContent = "Let's secure your account with a PIN.";
            bannerEl.style.display = 'block';
          } else {
            greetingEl.innerHTML = `${greeting}, <span class="highlight">${CURRENT_USER.name}</span>!`;
            subtitleEl.textContent = "Your account is secure and ready.";
            bannerEl.style.display = 'none';
          }

          // REAL-TIME LISTENER
          if (transactionsListener) transactionsListener();
          transactionsListener = onSnapshot(
            query(collection(db, `users/${CURRENT_USER.id}/transactions`), orderBy('timestamp', 'desc')),
            (snapshot) => {
              const txs = [];
              snapshot.forEach(doc => txs.push({ id: doc.id, ...doc.data() }));
              renderTransactions(txs);
            },
            (err) => console.error("Transaction listener error:", err)
          );

          const userListener = onSnapshot(doc(db, 'users', CURRENT_USER.id), (doc) => {
            if (doc.exists()) {
              const data = doc.data();
              CURRENT_USER.balance = data.balance || 0;
              document.getElementById('userBalance').textContent = formatBalance(CURRENT_USER.balance);
            }
          });

        } catch (err) {
          console.error('Auth error:', err);
          alert('Error: ' + err.message);
          await signOut(auth);
          window.location.href = 'login.html';
        }

        if (!document.getElementById('logoutBtn').dataset.listener) {
          document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            if (transactionsListener) transactionsListener();
            await signOut(auth);
            window.location.href = 'login.html';
          });
          document.getElementById('logoutBtn').dataset.listener = 'true';
        }

        if (!document.querySelector('.mobile-menu-toggle').dataset.listener) {
          document.querySelector('.mobile-menu-toggle').addEventListener('click', () => {
            navLinks.classList.toggle('active');
          });
          navLinks.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => navLinks.classList.remove('active'));
          });
          document.querySelector('.mobile-menu-toggle').dataset.listener = 'true';
        }
      });
    });

    // SET PIN
    document.getElementById('setPinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newPin = document.getElementById('newPin').value;
      const confirmPin = document.getElementById('confirmPin').value;
      if (newPin !== confirmPin) return alert('PINs do not match');
      if (newPin.length !== 4 || !/^\d+$/.test(newPin)) return alert('Enter a valid 4-digit PIN');
      try {
        await updateDoc(doc(db, 'users', CURRENT_USER.id), { pin: newPin });
        CURRENT_USER.pin = newPin;
        window.closeModal();
        alert('PIN set successfully!');
        location.reload();
      } catch (err) {
        alert('Failed: ' + err.message);
      }
    });

    // CHANGE PIN
    document.getElementById('changePinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const oldPin = document.getElementById('oldPin').value;
      const newPin = document.getElementById('newPinChange').value;
      const confirmPin = document.getElementById('confirmNewPin').value;

      if (oldPin !== CURRENT_USER.pin) return alert('Incorrect current PIN');
      if (newPin !== confirmPin) return alert('New PINs do not match');
      if (newPin.length !== 4 || !/^\d+$/.test(newPin)) return alert('Enter a valid 4-digit PIN');

      try {
        await updateDoc(doc(db, 'users', CURRENT_USER.id), { pin: newPin });
        CURRENT_USER.pin = newPin;
        window.closeModal();
        alert('PIN changed successfully!');
      } catch (err) {
        alert('Failed: ' + err.message);
      }
    });

    // EDIT PROFILE: PIN VERIFY FIRST
    document.getElementById('editPinVerifyForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const pin = document.getElementById('editVerifyPin').value;
      if (pin !== CURRENT_USER.pin) return alert('Incorrect PIN');
      window.closeModal();
      // Populate and open real edit form
      document.getElementById('editName').value = CURRENT_USER.name;
      document.getElementById('editEmail').value = CURRENT_USER.email;
      document.getElementById('editPhone').value = CURRENT_USER.phone || '';
      document.getElementById('editAddress').value = CURRENT_USER.address || '';
      document.getElementById('editDOB').value = CURRENT_USER.dob || '';
      window.openModal('editProfileModal');
    });

    // FINAL EDIT PROFILE SAVE
    document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('editName').value.trim();
      const email = document.getElementById('editEmail').value.trim().toLowerCase();
      const phone = document.getElementById('editPhone').value.trim();
      const address = document.getElementById('editAddress').value.trim();
      const dob = document.getElementById('editDOB').value;

      if (!name || !email) return alert('Name and email required');
      if (USERS.some(u => u.id !== CURRENT_USER.id && u.email === email)) return alert('Email taken');

      try {
        await updateEmail(auth.currentUser, email);
        await updateDoc(doc(db, 'users', CURRENT_USER.id), { name, email, phone, address, dob });
        CURRENT_USER = { ...CURRENT_USER, name, email, phone, address, dob };
        window.closeModal();
        alert('Profile updated!');
        location.reload();
      } catch (err) {
        alert('Update failed: ' + err.message);
      }
    });
  </script>
</body>
</html>